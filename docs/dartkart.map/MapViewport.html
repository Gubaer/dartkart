        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>MapViewport class / dartkart.map Library / Dart Documentation</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="//fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        </head>
        <body data-library="dartkart.map" data-type="MapViewport">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">Dart Documentation</a>
         &rsaquo; <a href="../dartkart.map.html">dartkart.map</a> &rsaquo; <a href="../dartkart.map/MapViewport.html">MapViewport</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
<h2><div class="icon-library"></div><a href="../dartkart.html">dartkart</a></h2><h2><div class="icon-library"></div><a href="../dartkart.core.html">dartkart.core</a></h2><h2><div class="icon-library"></div><a href="../dartkart.geo.html">dartkart.geo</a></h2><h2><div class="icon-library"></div><a href="../dartkart.geometry.html">dartkart.geometry</a></h2><h2><div class="icon-library"></div><a href="../dartkart.layer.html">dartkart.layer</a></h2><h2><div class="icon-library"></div><a href="../dartkart.map.html">dartkart.map</a></h2><ul class="icon">
<li><a href="../dartkart.map/ControlsPane.html"><div class="icon-class"></div>ControlsPane</a></li>
<li><a href="../dartkart.map/LayerControl.html"><div class="icon-class"></div>LayerControl</a></li>
<li><a href="../dartkart.map/LayerEvent.html"><div class="icon-class"></div>LayerEvent</a></li>
<li><a href="../dartkart.map/MapControl.html"><div class="icon-class"></div>MapControl</a></li>
<li><div class="icon-class"></div><strong>MapViewport</strong></li>
<li><a href="../dartkart.map/MouseEvent.html"><div class="icon-class"></div>MouseEvent</a></li>
<li><a href="../dartkart.map/MouseEventStream.html"><div class="icon-class"></div>MouseEventStream</a></li>
<li><a href="../dartkart.map/PanBehaviour.html"><div class="icon-class"></div>PanBehaviour</a></li>
<li><a href="../dartkart.map/PanControl.html"><div class="icon-class"></div>PanControl</a></li>
<li><a href="../dartkart.map/ScaleIndicatorControl.html"><div class="icon-class"></div>ScaleIndicatorControl</a></li>
<li><a href="../dartkart.map/SimpleZoomControl.html"><div class="icon-class"></div>SimpleZoomControl</a></li>
<li><a href="../dartkart.map/ZoomControl.html"><div class="icon-class"></div>ZoomControl</a></li>
</ul>
</div>
<div class="content">
        <h2><strong>MapViewport</strong>
          class
        </h2>
        
<button id="show-inherited" class="show-inherited">Hide inherited</button>
<div class="doc">
<p>A MapViewport provides a view on a rectangular area of a map
plane in a stack of map planes on different zoom levels.</p>
<p>It also provides the functionality to change between map
planes (zoom in and zoom out) and to move the viewport
around on the current map plane (pan left, rigth, up, or down). </p>
<p>A MapViewport manages a stack of map <code>Layer</code>s. </p>
<p>A MapViewport is a <code>PropertyObservable</code>. It emits propery change
events for
<em> <code>zoom</code>  - emitted if the zoom level is changed
</em> <code>center</code>  - emitted if the center of the map viewport is changed</p>
<pre class="source">
class MapViewport extends Object with PropertyObservable{

 DivElement _root;

 /// the root DOM element of the map viewport
 Element get root =&gt; _root;

 //TODO: make configurable.
 final ProjectedCRS _crs = new EPSG3857();
 ProjectedCRS get crs =&gt; _crs;

 /**
  * Creates a map viewport.
  *
  * [container] is either an [Element] or a string consisting of
  * a CSS selector.
  */
 MapViewport(container) {
   _require(container != null,"container must not be null");
   if (container is String) {
     container = query(container);
     _require(container != null, "didn't find container with id '$container'");
   } else if (container is Element) {
     // OK
   } else {
     _require(false,"expected Element or String, got $container");
   }
   _root = new DivElement()
     ..classes.add("dartkart-map-viewport");
   
   container.children
     ..clear()
     ..add(_root);
   attachEventListeners();
   controlsPane = new ControlsPane();
 }

 void attachEventListeners() {
   //TODO: remind subscription; solve detach
   _root.onMouseWheel.listen(_onMouseWheel);
   new _DragController(this);
   new _DoubleClickController(this);
 }

 /// Transforms projected coordinates [p] to coordinates in the current map
 /// zoom plane
 Point2D mapToZoomPlane(Point2D p) {
   var zp = zoomPlaneSize;
   var w = _crs.projectedBounds.width;
   var h = _crs.projectedBounds.height;
   return p.flipY()
    .translate(dx: w/2, dy: h/2)
    .scale(sx: zp.width/w, sy: zp.height/h)
    .toInt();
 }

 /// Transforms coordinates [p] in the current map zoom plane to
 /// projected coordinates
 Point2D zoomPlaneToMap(Point2D p) {
   var zp = zoomPlaneSize;
   var w = _crs.projectedBounds.width;
   var h = _crs.projectedBounds.height;
   return p.scale(sx: w/zp.width, sy: h/zp.height)
       .translate(dx:-w/2, dy:-h/2)
       .flipY();
 }

 /// Transforms coordinates in the current map zoom plane to viewport
 /// coordinates
 Point2D zoomPlaneToViewport(Point2D p) {
  var centerOnZoomPlane = mapToZoomPlane(earthToMap(center));
  return (p - centerOnZoomPlane).toInt() + (viewportSize / 2);
 }

 /// viewport coordinates to coordinates in the current map zoom plane
 Point2D viewportToZoomPlane(Point2D p) {
   var centerOnZoomPlane = mapToZoomPlane(earthToMap(center));
   var delta = p - (viewportSize / 2);
   return (centerOnZoomPlane + delta).toInt();
 }

 /// Transforms geographic coordinates [ll] to projected coordinates
 Point2D earthToMap(LatLon ll) =&gt; _crs.project(ll);

 /// Transforms projected coordinates [p] to geographic coordinates
 LatLon mapToEarth(Point2D p) =&gt; _crs.unproject(p);

 /// the viewport size
 Dimension get viewportSize =&gt;
     new Dimension(_root.client.width, _root.client.height);

 /// the size of the current map zoom plane
 Dimension get zoomPlaneSize {
   var dim = (1 &lt;&lt; zoom) * 256;
   return new Dimension(dim, dim);
 }

 /// the top-left point in "page coordinates"
 Point2D get topLeftInPage {
   offset(Element e) {
     var p = new Point2D(e.offset.left, e.offset.top);
     return e.parent == null ? p : p + offset(e.parent);
   }
   return offset(_root);
 }

 /**
  * The bounding box of the viewport in which we are currently rending
  * part of the map.
  *
  * The screen bounding box depends on the current zoom level ant the
  * current map center. In most cases, in partiuclar on zoom levels &gt; 2,
  * it is equal to the extend of the map viewport. In lower zoom levels,
  * where the zoom plane is smaller than the map viewport, or if the
  * center is moved very far east, west, north, or south, it only covers
  * part of the viewport.
  *
  */
 Bounds get screenBoundingBox {
   var vpSize = viewportSize;
   var vpCenter = (viewportSize / 2).toInt();
   var zpSize = zoomPlaneSize;
   var zpCenter = mapToZoomPlane(earthToMap(center));
   var zp = zoomPlaneSize;
   var x = math.max(0, vpCenter.x - zpCenter.x);
   var y = math.max(0, vpCenter.y - zpCenter.y);
   var width = math.min(vpSize.x, vpCenter.x  + (zpSize.x - zpCenter.x));
   var height = math.min(vpSize.y, vpCenter.y  + (zpSize.y - zpCenter.y));
   return new Bounds([x,y], [x+width, y+height]);
 }

 /**
  * Transforms page coordinates to viewport coordinates.
  *
  * [v] is either
  *   * a [Point2D]
  *   * a [MouseEvent] - uses the coordinates (pageX, pageY)
  *
  *  The result are viewport coordinates for the map viewport where
  *    * (0,0) is the upper left corner of the map viewport
  *    * x runs to the right
  *    * y runs down
  */
 Point2D pageToViewport(v) {
   if (v is MouseEvent) {
     v = new Point2D(v.page.x, v.page.y);
   } else if (v is Point2D) {} // do nothing
   else throw new ArgumentError("expected MouseEvent or Point2D, got $v");
   return v - topLeftInPage;
 }

 /**
  * Renders the map.
  */
 void render() {
   _layers.forEach((l)=&gt; l.render());
   _controlsPane.layout();
 }

 /* ----------------------- layer handling -------------------------- */
 final List&lt;Layer&gt; _layers = [];

 /// update the z-indexes of the layer. Reflects the ordering in
 /// the layer stack. The layer with the highest index is renderer
 /// on top, the layer with index 0 is rendered at the bottom.
 _updateLayerZIndex() {
   var reversed = _layers.reversed.toList();
   for (int i=0; i&lt;layers.length; i++) {
     reversed[i].container.style.zIndex = (i * -100).toString();
   }
 }

 /**
  * Adds a [layer] to the map.
  *
  * [layer] is appended to the list of layers of this map. It therefore
  * has the highest layer index and becomes rendered on top of the layer
  * stack of this map.
  *
  * Throws [ArgumentError] if [layer] is null. [layer] is ignored if it
  * is already attached to this map.
  *
  * ##Example
  *    var source= "http://a.tile.openstreetmap.org/{z}/{x}/{y}.png";
  *    map.addLayer(new OsmLayer(tileSource: source));
  */
 void addLayer(Layer layer) {
   _require(layer != null, "layer must not be null");
   if (hasLayer(layer)) return;
   _layers.add(layer);
   _root.children.add(layer.container);
   layer.attach(this);
   _updateLayerZIndex();
   render();
   _notifyLayerEvent(layer,LayerEvent.ADDED);
 }

 /**
  * Removes [layer] from the stack of layers of this map.
  *
  * Ignores [layer] if it is null or if it isn't attached to this map.
  */
 void removeLayer(Layer layer) {
   if (layer == null) return;
   if (!hasLayer(layer)) return;
   layer.detach();
   _root.children.remove(layer.container);
   _layers.remove(layer);
   _updateLayerZIndex();
   render();
   _notifyLayerEvent(layer,LayerEvent.REMOVED);
 }

 /// true, if [layer] is part of the layer stack of this map
 bool hasLayer(Layer layer) =&gt; _layers.contains(layer);

 /// an unmodifiable list of layers of this map. Empty, if
 /// no layes are defined.
 List&lt;Layer&gt; get layers =&gt; new UnmodifiableListView(_layers);

 /**
  * Moves the [layer] to the top.
  */
 void moveToTop(Layer layer) {
   if (!hasLayer(layer)) return;
   _layers.remove(layer);
   _layers.add(layer);
   _updateLayerZIndex();
   _notifyLayerEvent(layer,LayerEvent.MOVED);
 }

 /**
  * Moves the [layer] to the bottom.
  */
 void moveToBottom(Layer layer) {
   if (!hasLayer(layer)) return;
   _layers
     ..remove(layer)
     ..insert(0, layer);
   _updateLayerZIndex();
   _notifyLayerEvent(layer,LayerEvent.MOVED);
 }

 /**
  * Moves the [layer] to the position [index] in the
  * layer stack.
  */
 void moveTo(Layer layer, int index) {
   if (!hasLayer(layer)) return;
   index = math.max(index, 0);
   index = math.min(index, _layers.length);
   _layers
     ..remove(layer)
     ..insert(index,layer);
   _updateLayerZIndex();
   _notifyLayerEvent(layer,LayerEvent.MOVED);
 }

 final StreamController&lt;LayerEvent&gt; _layerEventsController =
     new StreamController&lt;LayerEvent&gt;();
 Stream&lt;LayerEvent&gt; _layerEventsStream;
 
 _notifyLayerEvent(layer, type) {
   if (!_layerEventsController.hasListener) return;
   if (_layerEventsController.isPaused) return;
   var event = new LayerEvent(this, layer, type);
   _layerEventsController.sink.add(event);
 }

 /**
  * Stream of layer change events.
  *
  * ## Example
  *
  *     map.onLayersChanged
  *       .where((LayerEvent e) =&gt; e.type == LayerEvent.ADDED))
  *       .listen((LayerEvent e) {
  *           print("layer added - num layers: ${map.layers.length}");
  *       });
  */
 Stream&lt;LayerEvent&gt; get onLayersChanged {
   if (_layerEventsStream == null) {
     _layerEventsStream = _layerEventsController.stream.asBroadcastStream();
   }
   return _layerEventsStream;
 }

 /* ----------------------- zooming       --------------------------- */
 int _zoom = 0;

 /// the current zoom level
 int get zoom =&gt; _zoom;

 /**
  * Set the zoom level [zoom].
  *
  * [zoom] &gt;= 0 expected, otherwise throws an [ArgumentError].
  */
 void set zoom(int value) {
   _require(value &gt;= 0, "zoom &gt;= 0 expected, got $value");
   if (value == _zoom) return;
   _zoom = value;
   render();
   notify("zoom", _zoom, value);
 }

 /**
  * Zoom in by [delta] zoom levels.
  *
  * Throws [ArgumentError] if [delta] &lt; 0. Fires a zoom change event.
  */
 void zoomIn([int delta=1]) {
   _require(delta &gt;= 0, "delta &gt;= 0 expected, got $delta");
   if (delta == 0) return;

   //TODO: check for max zoom level
   var oldZoom = _zoom;
   _zoom+= delta;
   render();
   notify("zoom", oldZoom, _zoom);
 }

 /**
  * Zoom out by [delta] zoom levels.
  *
  * Throws [ArgumentError] if [delta] &lt; 0. Fires a zoom change event.
  */
 void zoomOut([int delta=1]) {
   if (delta &lt; 0) throw new ArgumentError("delta &gt;= 0 expected, got $delta");
   if (delta == 0) return;
   var oldZoom = _zoom;
   _zoom = math.max(0, _zoom - delta);
   render();
   notify("zoom", oldZoom, _zoom);
 }

 /* ----------------------- event handlers --------------------------- */
 _onMouseWheel(WheelEvent evt) {
   var doZoom = evt.deltaY &lt; 0 ? zoomIn : zoomOut;
   doZoom();
 }

 /* --------------------- map center ---------------------------------- */
 LatLon _center = new LatLon.origin();

 /// the current map center in geographic coordinates
 LatLon get center =&gt; _center;

 /**
  * Sets the current map [center].
  *
  * [center] must not be null. Broadcasts a [PropertyChangeEvent] if
  * the center is changed, see [onCenterChanged].
  */
 void set center(LatLon value) {
   _require(value != null, "center must not be null");
   if (_center == value) return;
   var old = _center;
   _center = value;    
   render();
   notify("center", old, _center);
 }

 /* --------------------- panning ---------------------------------- */
 void pan(delta, {bool animate: false}) {
   if (animate) {
     new PanBehaviour(this).animate(new Point2D.from(delta));
   } else {
     delta = new Point2D.from(delta);
     var p = mapToZoomPlane(earthToMap(center));
     p = p + delta;
     if (p.x &lt;= 0 || p.y &lt;= 0) return;
     var size = zoomPlaneSize;
     if (p.x &gt;= size.width || p.y &gt;= size.height) return;
     var c = zoomPlaneToMap(p);
     if (!crs.projectedBounds.contains(c)) return;
     center = mapToEarth(c);
   }
 }

 /// Pans the viewport num [pixels] to the north.
 /// Animates panning if [animate] is true.
 void panNorth({int pixels:100, bool animate:false}) =&gt;
     pan([0,-pixels], animate: animate);

 /// Pans the viewport num [pixels] to the south.
 /// Animates panning if [animate] is true.
 void panSouth({int pixels:100, bool animate:false}) =&gt;
     pan([0,pixels], animate: animate);

 /// Pans the viewport num [pixels] to the west
 /// Animates panning if [animate] is true.
 void panWest({int pixels:100, bool animate:false}) =&gt;
     pan([-pixels, 0], animate: animate);

 /// Pans the viewport num [pixels] to the east
 /// Animates panning if [animate] is true.
 void panEast({int pixels:100, bool animate:false}) =&gt;
     pan([pixels, 0],animate: animate);

 /* ----------------------- controls pane ------------------------ */
 ControlsPane _controlsPane;

 /// the pane with the interactive map controls
 ControlsPane get controlsPane =&gt; _controlsPane;

 /// sets the [pane] for the interactive map controls
 void set controlsPane(ControlsPane pane) {
   if (pane == _controlsPane) return; // don't add twice
   if (_controlsPane != null) {
     _controlsPane.detach();
     _root.children.remove(_controlsPane.root);
   }
   _controlsPane = pane;
   if (_controlsPane != null) {
     _controlsPane
       ..attach(this)
       // render the controls pane on top of the map layers.
       // The z-index for the top most layer is 0.
       ..root.style.zIndex = "100";
     _root.children.add(_controlsPane.root);
   }
 }
}
</pre>
</div>
<h3>Extends</h3>
<p>
<span class="type-box"><span class="icon-class"></span><a href="../dartkart.map/Object_PropertyObservable.html">Object_PropertyObservable</a></span>&nbsp;&gt;&nbsp;<span class="type-box"><span class="icon-class"></span><strong>MapViewport</strong></span></p>
<div>
<h3>Constructors</h3>
<div class="method"><h4 id="MapViewport">
<button class="show-code">Code</button>
new <strong>MapViewport</strong>(container) <a class="anchor-link" href="#MapViewport"
              title="Permalink to MapViewport.MapViewport">#</a></h4>
<div class="doc">
<p>Creates a map viewport.</p>
<p>
<span class="param">container</span> is either an <code>Element</code> or a string consisting of
a CSS selector.</p>
<pre class="source">
MapViewport(container) {
 _require(container != null,"container must not be null");
 if (container is String) {
   container = query(container);
   _require(container != null, "didn't find container with id '$container'");
 } else if (container is Element) {
   // OK
 } else {
   _require(false,"expected Element or String, got $container");
 }
 _root = new DivElement()
   ..classes.add("dartkart-map-viewport");
 
 container.children
   ..clear()
   ..add(_root);
 attachEventListeners();
 controlsPane = new ControlsPane();
}
</pre>
</div>
</div>
</div>
<div>
<h3>Properties</h3>
<div class="method"><h4 id="center">
<button class="show-code">Code</button>
<a href="../dartkart.geo/LatLon.html">LatLon</a> <strong>get center</strong> <a class="anchor-link" href="#center"
              title="Permalink to MapViewport.get center">#</a></h4>
<div class="doc">
<p>the current map center in geographic coordinates</p>
<pre class="source">
LatLon get center =&gt; _center;
</pre>
</div>
</div>
<div class="method"><h4 id="center=">
<button class="show-code">Code</button>
void <strong>set center</strong>(<a href="../dartkart.geo/LatLon.html">LatLon</a> value) <a class="anchor-link" href="#center="
              title="Permalink to MapViewport.set center">#</a></h4>
<div class="doc">
<p>Sets the current map <a class="crossref" href="../dartkart.map/MapViewport.html#center">center</a>.</p>
<p><a class="crossref" href="../dartkart.map/MapViewport.html#center">center</a> must not be null. Broadcasts a <code>PropertyChangeEvent</code> if
the center is changed, see <code>onCenterChanged</code>.</p>
<pre class="source">
void set center(LatLon value) {
 _require(value != null, "center must not be null");
 if (_center == value) return;
 var old = _center;
 _center = value;    
 render();
 notify("center", old, _center);
}
</pre>
</div>
</div>
<div class="method"><h4 id="controlsPane">
<button class="show-code">Code</button>
<a href="../dartkart.map/ControlsPane.html">ControlsPane</a> <strong>get controlsPane</strong> <a class="anchor-link" href="#controlsPane"
              title="Permalink to MapViewport.get controlsPane">#</a></h4>
<div class="doc">
<p>the pane with the interactive map controls</p>
<pre class="source">
ControlsPane get controlsPane =&gt; _controlsPane;
</pre>
</div>
</div>
<div class="method"><h4 id="controlsPane=">
<button class="show-code">Code</button>
void <strong>set controlsPane</strong>(<a href="../dartkart.map/ControlsPane.html">ControlsPane</a> pane) <a class="anchor-link" href="#controlsPane="
              title="Permalink to MapViewport.set controlsPane">#</a></h4>
<div class="doc">
<p>sets the 
<span class="param">pane</span> for the interactive map controls</p>
<pre class="source">
void set controlsPane(ControlsPane pane) {
 if (pane == _controlsPane) return; // don't add twice
 if (_controlsPane != null) {
   _controlsPane.detach();
   _root.children.remove(_controlsPane.root);
 }
 _controlsPane = pane;
 if (_controlsPane != null) {
   _controlsPane
     ..attach(this)
     // render the controls pane on top of the map layers.
     // The z-index for the top most layer is 0.
     ..root.style.zIndex = "100";
   _root.children.add(_controlsPane.root);
 }
}
</pre>
</div>
</div>
<div class="field"><h4 id="crs">
<button class="show-code">Code</button>
final <a href="../dartkart.geo/ProjectedCRS.html">ProjectedCRS</a>         <strong>crs</strong> <a class="anchor-link"
            href="#crs"
            title="Permalink to MapViewport.crs">#</a>
        </h4>
        <div class="doc">
<pre class="source">
ProjectedCRS get crs =&gt; _crs;
</pre>
</div>
</div>
<div class="field"><h4 id="layers">
<button class="show-code">Code</button>
final <a href="http://api.dartlang.org/dart_core/List.html">List</a>&lt;<a href="../dartkart.layer/Layer.html">Layer</a>&gt;         <strong>layers</strong> <a class="anchor-link"
            href="#layers"
            title="Permalink to MapViewport.layers">#</a>
        </h4>
        <div class="doc">
<p>an unmodifiable list of layers of this map. Empty, if
no layes are defined.</p>
<pre class="source">
List&lt;Layer&gt; get layers =&gt; new UnmodifiableListView(_layers);
</pre>
</div>
</div>
<div class="field"><h4 id="onLayersChanged">
<button class="show-code">Code</button>
final <a href="http://api.dartlang.org/dart_async/Stream.html">Stream</a>&lt;<a href="../dartkart.map/LayerEvent.html">LayerEvent</a>&gt;         <strong>onLayersChanged</strong> <a class="anchor-link"
            href="#onLayersChanged"
            title="Permalink to MapViewport.onLayersChanged">#</a>
        </h4>
        <div class="doc">
<p>Stream of layer change events.</p>
<h2>Example</h2>
<pre><code>map.onLayersChanged
  .where((LayerEvent e) =&gt; e.type == LayerEvent.ADDED))
  .listen((LayerEvent e) {
      print("layer added - num layers: ${map.layers.length}");
  });
</code></pre>
<pre class="source">
Stream&lt;LayerEvent&gt; get onLayersChanged {
 if (_layerEventsStream == null) {
   _layerEventsStream = _layerEventsController.stream.asBroadcastStream();
 }
 return _layerEventsStream;
}
</pre>
</div>
</div>
<div class="field inherited"><h4 id="onPropertyChanged">
<button class="show-code">Code</button>
final <a href="http://api.dartlang.org/dart_async/Stream.html">Stream</a>&lt;<a href="../dartkart.core/PropertyChangeEvent.html">PropertyChangeEvent</a>&gt;         <strong>onPropertyChanged</strong> <a class="anchor-link"
            href="#onPropertyChanged"
            title="Permalink to MapViewport.onPropertyChanged">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../dartkart.map/Object_PropertyObservable.html">Object_PropertyObservable</a> </div><div class="doc">
<p>the stream of property change events</p>
<h2>Example</h2>
<pre><code> // an observable with a mixed in PropertyObservable
 var observable = ...;
 // listen for property change events for the property
 // 'my_property'
 observable.onPropertyChanged
   .where((evt) =&gt; evt.name == "my_property")
   .listen((evt) =&gt; print("new value: ${evt.newValue}"));
</code></pre>
<pre class="source">
Stream&lt;PropertyChangeEvent&gt; get onPropertyChanged {
 //TODO: fix this - if at least one listener is present,
 // change events are emitted, regardless of whether the
 // individual listeners are paused or not. Consequence:
 // lots of change events are possibly queued up in
 // paused listener streams. =&gt; need a custom implementation
 // of a multiplexing stream which disards events if
 // they are streamed to a disabled listener
 //
 if (_stream == null) {
   _stream = _controller.stream.asBroadcastStream();
 }
 return _stream;
}
</pre>
</div>
</div>
<div class="field"><h4 id="root">
<button class="show-code">Code</button>
final <a href="http://api.dartlang.org/dart_html/Element.html">Element</a>         <strong>root</strong> <a class="anchor-link"
            href="#root"
            title="Permalink to MapViewport.root">#</a>
        </h4>
        <div class="doc">
<p>the root DOM element of the map viewport</p>
<pre class="source">
Element get root =&gt; _root;
</pre>
</div>
</div>
<div class="field"><h4 id="screenBoundingBox">
<button class="show-code">Code</button>
final <a href="../dartkart.geometry/Bounds.html">Bounds</a>         <strong>screenBoundingBox</strong> <a class="anchor-link"
            href="#screenBoundingBox"
            title="Permalink to MapViewport.screenBoundingBox">#</a>
        </h4>
        <div class="doc">
<p>The bounding box of the viewport in which we are currently rending
part of the map.</p>
<p>The screen bounding box depends on the current zoom level ant the
current map center. In most cases, in partiuclar on zoom levels > 2,
it is equal to the extend of the map viewport. In lower zoom levels,
where the zoom plane is smaller than the map viewport, or if the
center is moved very far east, west, north, or south, it only covers
part of the viewport.</p>
<pre class="source">
Bounds get screenBoundingBox {
 var vpSize = viewportSize;
 var vpCenter = (viewportSize / 2).toInt();
 var zpSize = zoomPlaneSize;
 var zpCenter = mapToZoomPlane(earthToMap(center));
 var zp = zoomPlaneSize;
 var x = math.max(0, vpCenter.x - zpCenter.x);
 var y = math.max(0, vpCenter.y - zpCenter.y);
 var width = math.min(vpSize.x, vpCenter.x  + (zpSize.x - zpCenter.x));
 var height = math.min(vpSize.y, vpCenter.y  + (zpSize.y - zpCenter.y));
 return new Bounds([x,y], [x+width, y+height]);
}
</pre>
</div>
</div>
<div class="field"><h4 id="topLeftInPage">
<button class="show-code">Code</button>
final <a href="../dartkart.geometry/Point2D.html">Point2D</a>         <strong>topLeftInPage</strong> <a class="anchor-link"
            href="#topLeftInPage"
            title="Permalink to MapViewport.topLeftInPage">#</a>
        </h4>
        <div class="doc">
<p>the top-left point in "page coordinates"</p>
<pre class="source">
Point2D get topLeftInPage {
 offset(Element e) {
   var p = new Point2D(e.offset.left, e.offset.top);
   return e.parent == null ? p : p + offset(e.parent);
 }
 return offset(_root);
}
</pre>
</div>
</div>
<div class="field"><h4 id="viewportSize">
<button class="show-code">Code</button>
final <a href="../dartkart.geometry/Dimension.html">Dimension</a>         <strong>viewportSize</strong> <a class="anchor-link"
            href="#viewportSize"
            title="Permalink to MapViewport.viewportSize">#</a>
        </h4>
        <div class="doc">
<p>the viewport size</p>
<pre class="source">
Dimension get viewportSize =&gt;
   new Dimension(_root.client.width, _root.client.height);
</pre>
</div>
</div>
<div class="method"><h4 id="zoom">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/int.html">int</a> <strong>get zoom</strong> <a class="anchor-link" href="#zoom"
              title="Permalink to MapViewport.get zoom">#</a></h4>
<div class="doc">
<p>the current zoom level</p>
<pre class="source">
int get zoom =&gt; _zoom;
</pre>
</div>
</div>
<div class="method"><h4 id="zoom=">
<button class="show-code">Code</button>
void <strong>set zoom</strong>(<a href="http://api.dartlang.org/dart_core/int.html">int</a> value) <a class="anchor-link" href="#zoom="
              title="Permalink to MapViewport.set zoom">#</a></h4>
<div class="doc">
<p>Set the zoom level <a class="crossref" href="../dartkart.map/MapViewport.html#zoom">zoom</a>.</p>
<p><a class="crossref" href="../dartkart.map/MapViewport.html#zoom">zoom</a> >= 0 expected, otherwise throws an <code>ArgumentError</code>.</p>
<pre class="source">
void set zoom(int value) {
 _require(value &gt;= 0, "zoom &gt;= 0 expected, got $value");
 if (value == _zoom) return;
 _zoom = value;
 render();
 notify("zoom", _zoom, value);
}
</pre>
</div>
</div>
<div class="field"><h4 id="zoomPlaneSize">
<button class="show-code">Code</button>
final <a href="../dartkart.geometry/Dimension.html">Dimension</a>         <strong>zoomPlaneSize</strong> <a class="anchor-link"
            href="#zoomPlaneSize"
            title="Permalink to MapViewport.zoomPlaneSize">#</a>
        </h4>
        <div class="doc">
<p>the size of the current map zoom plane</p>
<pre class="source">
Dimension get zoomPlaneSize {
 var dim = (1 &lt;&lt; zoom) * 256;
 return new Dimension(dim, dim);
}
</pre>
</div>
</div>
</div>
<div>
<h3>Methods</h3>
<div class="method"><h4 id="addLayer">
<button class="show-code">Code</button>
void <strong>addLayer</strong>(<a href="../dartkart.layer/Layer.html">Layer</a> layer) <a class="anchor-link" href="#addLayer"
              title="Permalink to MapViewport.addLayer">#</a></h4>
<div class="doc">
<p>Adds a 
<span class="param">layer</span> to the map.</p>
<p>
<span class="param">layer</span> is appended to the list of layers of this map. It therefore
has the highest layer index and becomes rendered on top of the layer
stack of this map.</p>
<p>Throws <code>ArgumentError</code> if 
<span class="param">layer</span> is null. 
<span class="param">layer</span> is ignored if it
is already attached to this map.</p>
<h2>Example</h2>
<p>   var source= "http://a.tile.openstreetmap.org/{z}/{x}/{y}.png";
   map.addLayer(new OsmLayer(tileSource: source));</p>
<pre class="source">
void addLayer(Layer layer) {
 _require(layer != null, "layer must not be null");
 if (hasLayer(layer)) return;
 _layers.add(layer);
 _root.children.add(layer.container);
 layer.attach(this);
 _updateLayerZIndex();
 render();
 _notifyLayerEvent(layer,LayerEvent.ADDED);
}
</pre>
</div>
</div>
<div class="method"><h4 id="attachEventListeners">
<button class="show-code">Code</button>
void <strong>attachEventListeners</strong>() <a class="anchor-link" href="#attachEventListeners"
              title="Permalink to MapViewport.attachEventListeners">#</a></h4>
<div class="doc">
<pre class="source">
void attachEventListeners() {
 //TODO: remind subscription; solve detach
 _root.onMouseWheel.listen(_onMouseWheel);
 new _DragController(this);
 new _DoubleClickController(this);
}
</pre>
</div>
</div>
<div class="method"><h4 id="earthToMap">
<button class="show-code">Code</button>
<a href="../dartkart.geometry/Point2D.html">Point2D</a> <strong>earthToMap</strong>(<a href="../dartkart.geo/LatLon.html">LatLon</a> ll) <a class="anchor-link" href="#earthToMap"
              title="Permalink to MapViewport.earthToMap">#</a></h4>
<div class="doc">
<p>Transforms geographic coordinates 
<span class="param">ll</span> to projected coordinates</p>
<pre class="source">
Point2D earthToMap(LatLon ll) =&gt; _crs.project(ll);
</pre>
</div>
</div>
<div class="method"><h4 id="hasLayer">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/bool.html">bool</a> <strong>hasLayer</strong>(<a href="../dartkart.layer/Layer.html">Layer</a> layer) <a class="anchor-link" href="#hasLayer"
              title="Permalink to MapViewport.hasLayer">#</a></h4>
<div class="doc">
<p>true, if 
<span class="param">layer</span> is part of the layer stack of this map</p>
<pre class="source">
bool hasLayer(Layer layer) =&gt; _layers.contains(layer);
</pre>
</div>
</div>
<div class="method"><h4 id="mapToEarth">
<button class="show-code">Code</button>
<a href="../dartkart.geo/LatLon.html">LatLon</a> <strong>mapToEarth</strong>(<a href="../dartkart.geometry/Point2D.html">Point2D</a> p) <a class="anchor-link" href="#mapToEarth"
              title="Permalink to MapViewport.mapToEarth">#</a></h4>
<div class="doc">
<p>Transforms projected coordinates 
<span class="param">p</span> to geographic coordinates</p>
<pre class="source">
LatLon mapToEarth(Point2D p) =&gt; _crs.unproject(p);
</pre>
</div>
</div>
<div class="method"><h4 id="mapToZoomPlane">
<button class="show-code">Code</button>
<a href="../dartkart.geometry/Point2D.html">Point2D</a> <strong>mapToZoomPlane</strong>(<a href="../dartkart.geometry/Point2D.html">Point2D</a> p) <a class="anchor-link" href="#mapToZoomPlane"
              title="Permalink to MapViewport.mapToZoomPlane">#</a></h4>
<div class="doc">
<p>Transforms projected coordinates 
<span class="param">p</span> to coordinates in the current map
zoom plane</p>
<pre class="source">
Point2D mapToZoomPlane(Point2D p) {
 var zp = zoomPlaneSize;
 var w = _crs.projectedBounds.width;
 var h = _crs.projectedBounds.height;
 return p.flipY()
  .translate(dx: w/2, dy: h/2)
  .scale(sx: zp.width/w, sy: zp.height/h)
  .toInt();
}
</pre>
</div>
</div>
<div class="method"><h4 id="moveTo">
<button class="show-code">Code</button>
void <strong>moveTo</strong>(<a href="../dartkart.layer/Layer.html">Layer</a> layer, <a href="http://api.dartlang.org/dart_core/int.html">int</a> index) <a class="anchor-link" href="#moveTo"
              title="Permalink to MapViewport.moveTo">#</a></h4>
<div class="doc">
<p>Moves the 
<span class="param">layer</span> to the position 
<span class="param">index</span> in the
layer stack.</p>
<pre class="source">
void moveTo(Layer layer, int index) {
 if (!hasLayer(layer)) return;
 index = math.max(index, 0);
 index = math.min(index, _layers.length);
 _layers
   ..remove(layer)
   ..insert(index,layer);
 _updateLayerZIndex();
 _notifyLayerEvent(layer,LayerEvent.MOVED);
}
</pre>
</div>
</div>
<div class="method"><h4 id="moveToBottom">
<button class="show-code">Code</button>
void <strong>moveToBottom</strong>(<a href="../dartkart.layer/Layer.html">Layer</a> layer) <a class="anchor-link" href="#moveToBottom"
              title="Permalink to MapViewport.moveToBottom">#</a></h4>
<div class="doc">
<p>Moves the 
<span class="param">layer</span> to the bottom.</p>
<pre class="source">
void moveToBottom(Layer layer) {
 if (!hasLayer(layer)) return;
 _layers
   ..remove(layer)
   ..insert(0, layer);
 _updateLayerZIndex();
 _notifyLayerEvent(layer,LayerEvent.MOVED);
}
</pre>
</div>
</div>
<div class="method"><h4 id="moveToTop">
<button class="show-code">Code</button>
void <strong>moveToTop</strong>(<a href="../dartkart.layer/Layer.html">Layer</a> layer) <a class="anchor-link" href="#moveToTop"
              title="Permalink to MapViewport.moveToTop">#</a></h4>
<div class="doc">
<p>Moves the 
<span class="param">layer</span> to the top.</p>
<pre class="source">
void moveToTop(Layer layer) {
 if (!hasLayer(layer)) return;
 _layers.remove(layer);
 _layers.add(layer);
 _updateLayerZIndex();
 _notifyLayerEvent(layer,LayerEvent.MOVED);
}
</pre>
</div>
</div>
<div class="method inherited"><h4 id="notify">
<button class="show-code">Code</button>
void <strong>notify</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> property, oldValue, newValue) <a class="anchor-link" href="#notify"
              title="Permalink to MapViewport.notify">#</a></h4>
<div class="inherited-from">inherited from <a href="../dartkart.map/Object_PropertyObservable.html">Object_PropertyObservable</a> </div><div class="doc">
<p>Notifies observers about an update of the property with
name 
<span class="param">property</span> in this object. 
<span class="param">oldValue</span> was replaced
by 
<span class="param">newValue</span>.</p>
<p>Observers are only notified, provided 
<span class="param">newValue</span> is different
from 
<span class="param">oldValue</span> and if there is at least one listener.</p>
<pre class="source">
void notify(String property, oldValue, newValue) {
 if (oldValue == newValue) return;
 //TODO: fix me - see notes in onPropertyChanged
 if (!_controller.hasListener || _controller.isPaused) return;
 _controller.sink.add(
     new PropertyChangeEvent(this, property,oldValue,newValue)
 );
}
</pre>
</div>
</div>
<div class="method"><h4 id="pageToViewport">
<button class="show-code">Code</button>
<a href="../dartkart.geometry/Point2D.html">Point2D</a> <strong>pageToViewport</strong>(v) <a class="anchor-link" href="#pageToViewport"
              title="Permalink to MapViewport.pageToViewport">#</a></h4>
<div class="doc">
<p>Transforms page coordinates to viewport coordinates.</p>
<p>
<span class="param">v</span> is either
  * a <code>Point2D</code>
  * a <a class="crossref" href="../dartkart.map/MouseEvent.html">MouseEvent</a> - uses the coordinates (pageX, pageY)</p>
<p> The result are viewport coordinates for the map viewport where
   * (0,0) is the upper left corner of the map viewport
   * x runs to the right
   * y runs down</p>
<pre class="source">
Point2D pageToViewport(v) {
 if (v is MouseEvent) {
   v = new Point2D(v.page.x, v.page.y);
 } else if (v is Point2D) {} // do nothing
 else throw new ArgumentError("expected MouseEvent or Point2D, got $v");
 return v - topLeftInPage;
}
</pre>
</div>
</div>
<div class="method"><h4 id="pan">
<button class="show-code">Code</button>
void <strong>pan</strong>(delta, {<a href="http://api.dartlang.org/dart_core/bool.html">bool</a> animate: false}) <a class="anchor-link" href="#pan"
              title="Permalink to MapViewport.pan">#</a></h4>
<div class="doc">
<pre class="source">
void pan(delta, {bool animate: false}) {
 if (animate) {
   new PanBehaviour(this).animate(new Point2D.from(delta));
 } else {
   delta = new Point2D.from(delta);
   var p = mapToZoomPlane(earthToMap(center));
   p = p + delta;
   if (p.x &lt;= 0 || p.y &lt;= 0) return;
   var size = zoomPlaneSize;
   if (p.x &gt;= size.width || p.y &gt;= size.height) return;
   var c = zoomPlaneToMap(p);
   if (!crs.projectedBounds.contains(c)) return;
   center = mapToEarth(c);
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="panEast">
<button class="show-code">Code</button>
void <strong>panEast</strong>({<a href="http://api.dartlang.org/dart_core/int.html">int</a> pixels: 100, <a href="http://api.dartlang.org/dart_core/bool.html">bool</a> animate: false}) <a class="anchor-link" href="#panEast"
              title="Permalink to MapViewport.panEast">#</a></h4>
<div class="doc">
<p>Pans the viewport num 
<span class="param">pixels</span> to the east
Animates panning if 
<span class="param">animate</span> is true.</p>
<pre class="source">
void panEast({int pixels:100, bool animate:false}) =&gt;
   pan([pixels, 0],animate: animate);
</pre>
</div>
</div>
<div class="method"><h4 id="panNorth">
<button class="show-code">Code</button>
void <strong>panNorth</strong>({<a href="http://api.dartlang.org/dart_core/int.html">int</a> pixels: 100, <a href="http://api.dartlang.org/dart_core/bool.html">bool</a> animate: false}) <a class="anchor-link" href="#panNorth"
              title="Permalink to MapViewport.panNorth">#</a></h4>
<div class="doc">
<p>Pans the viewport num 
<span class="param">pixels</span> to the north.
Animates panning if 
<span class="param">animate</span> is true.</p>
<pre class="source">
void panNorth({int pixels:100, bool animate:false}) =&gt;
   pan([0,-pixels], animate: animate);
</pre>
</div>
</div>
<div class="method"><h4 id="panSouth">
<button class="show-code">Code</button>
void <strong>panSouth</strong>({<a href="http://api.dartlang.org/dart_core/int.html">int</a> pixels: 100, <a href="http://api.dartlang.org/dart_core/bool.html">bool</a> animate: false}) <a class="anchor-link" href="#panSouth"
              title="Permalink to MapViewport.panSouth">#</a></h4>
<div class="doc">
<p>Pans the viewport num 
<span class="param">pixels</span> to the south.
Animates panning if 
<span class="param">animate</span> is true.</p>
<pre class="source">
void panSouth({int pixels:100, bool animate:false}) =&gt;
   pan([0,pixels], animate: animate);
</pre>
</div>
</div>
<div class="method"><h4 id="panWest">
<button class="show-code">Code</button>
void <strong>panWest</strong>({<a href="http://api.dartlang.org/dart_core/int.html">int</a> pixels: 100, <a href="http://api.dartlang.org/dart_core/bool.html">bool</a> animate: false}) <a class="anchor-link" href="#panWest"
              title="Permalink to MapViewport.panWest">#</a></h4>
<div class="doc">
<p>Pans the viewport num 
<span class="param">pixels</span> to the west
Animates panning if 
<span class="param">animate</span> is true.</p>
<pre class="source">
void panWest({int pixels:100, bool animate:false}) =&gt;
   pan([-pixels, 0], animate: animate);
</pre>
</div>
</div>
<div class="method"><h4 id="removeLayer">
<button class="show-code">Code</button>
void <strong>removeLayer</strong>(<a href="../dartkart.layer/Layer.html">Layer</a> layer) <a class="anchor-link" href="#removeLayer"
              title="Permalink to MapViewport.removeLayer">#</a></h4>
<div class="doc">
<p>Removes 
<span class="param">layer</span> from the stack of layers of this map.</p>
<p>Ignores 
<span class="param">layer</span> if it is null or if it isn't attached to this map.</p>
<pre class="source">
void removeLayer(Layer layer) {
 if (layer == null) return;
 if (!hasLayer(layer)) return;
 layer.detach();
 _root.children.remove(layer.container);
 _layers.remove(layer);
 _updateLayerZIndex();
 render();
 _notifyLayerEvent(layer,LayerEvent.REMOVED);
}
</pre>
</div>
</div>
<div class="method"><h4 id="render">
<button class="show-code">Code</button>
void <strong>render</strong>() <a class="anchor-link" href="#render"
              title="Permalink to MapViewport.render">#</a></h4>
<div class="doc">
<p>Renders the map.</p>
<pre class="source">
void render() {
 _layers.forEach((l)=&gt; l.render());
 _controlsPane.layout();
}
</pre>
</div>
</div>
<div class="method"><h4 id="viewportToZoomPlane">
<button class="show-code">Code</button>
<a href="../dartkart.geometry/Point2D.html">Point2D</a> <strong>viewportToZoomPlane</strong>(<a href="../dartkart.geometry/Point2D.html">Point2D</a> p) <a class="anchor-link" href="#viewportToZoomPlane"
              title="Permalink to MapViewport.viewportToZoomPlane">#</a></h4>
<div class="doc">
<p>viewport coordinates to coordinates in the current map zoom plane</p>
<pre class="source">
Point2D viewportToZoomPlane(Point2D p) {
 var centerOnZoomPlane = mapToZoomPlane(earthToMap(center));
 var delta = p - (viewportSize / 2);
 return (centerOnZoomPlane + delta).toInt();
}
</pre>
</div>
</div>
<div class="method"><h4 id="zoomIn">
<button class="show-code">Code</button>
void <strong>zoomIn</strong>([<a href="http://api.dartlang.org/dart_core/int.html">int</a> delta = 1]) <a class="anchor-link" href="#zoomIn"
              title="Permalink to MapViewport.zoomIn">#</a></h4>
<div class="doc">
<p>Zoom in by 
<span class="param">delta</span> zoom levels.</p>
<p>Throws <code>ArgumentError</code> if 
<span class="param">delta</span> &lt; 0. Fires a zoom change event.</p>
<pre class="source">
void zoomIn([int delta=1]) {
 _require(delta &gt;= 0, "delta &gt;= 0 expected, got $delta");
 if (delta == 0) return;

 //TODO: check for max zoom level
 var oldZoom = _zoom;
 _zoom+= delta;
 render();
 notify("zoom", oldZoom, _zoom);
}
</pre>
</div>
</div>
<div class="method"><h4 id="zoomOut">
<button class="show-code">Code</button>
void <strong>zoomOut</strong>([<a href="http://api.dartlang.org/dart_core/int.html">int</a> delta = 1]) <a class="anchor-link" href="#zoomOut"
              title="Permalink to MapViewport.zoomOut">#</a></h4>
<div class="doc">
<p>Zoom out by 
<span class="param">delta</span> zoom levels.</p>
<p>Throws <code>ArgumentError</code> if 
<span class="param">delta</span> &lt; 0. Fires a zoom change event.</p>
<pre class="source">
void zoomOut([int delta=1]) {
 if (delta &lt; 0) throw new ArgumentError("delta &gt;= 0 expected, got $delta");
 if (delta == 0) return;
 var oldZoom = _zoom;
 _zoom = math.max(0, _zoom - delta);
 render();
 notify("zoom", oldZoom, _zoom);
}
</pre>
</div>
</div>
<div class="method"><h4 id="zoomPlaneToMap">
<button class="show-code">Code</button>
<a href="../dartkart.geometry/Point2D.html">Point2D</a> <strong>zoomPlaneToMap</strong>(<a href="../dartkart.geometry/Point2D.html">Point2D</a> p) <a class="anchor-link" href="#zoomPlaneToMap"
              title="Permalink to MapViewport.zoomPlaneToMap">#</a></h4>
<div class="doc">
<p>Transforms coordinates 
<span class="param">p</span> in the current map zoom plane to
projected coordinates</p>
<pre class="source">
Point2D zoomPlaneToMap(Point2D p) {
 var zp = zoomPlaneSize;
 var w = _crs.projectedBounds.width;
 var h = _crs.projectedBounds.height;
 return p.scale(sx: w/zp.width, sy: h/zp.height)
     .translate(dx:-w/2, dy:-h/2)
     .flipY();
}
</pre>
</div>
</div>
<div class="method"><h4 id="zoomPlaneToViewport">
<button class="show-code">Code</button>
<a href="../dartkart.geometry/Point2D.html">Point2D</a> <strong>zoomPlaneToViewport</strong>(<a href="../dartkart.geometry/Point2D.html">Point2D</a> p) <a class="anchor-link" href="#zoomPlaneToViewport"
              title="Permalink to MapViewport.zoomPlaneToViewport">#</a></h4>
<div class="doc">
<p>Transforms coordinates in the current map zoom plane to viewport
coordinates</p>
<pre class="source">
Point2D zoomPlaneToViewport(Point2D p) {
var centerOnZoomPlane = mapToZoomPlane(earthToMap(center));
return (p - centerOnZoomPlane).toInt() + (viewportSize / 2);
}
</pre>
</div>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        <div class="footer">
          <div>This page was generated at 2013-06-02 17:31:28.165</div>
        </div>
        <script async src="../client-static.js"></script>
        </body></html>
        
