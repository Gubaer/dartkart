        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>Tile class / dartkart.layer Library / Dart Documentation</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="//fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        </head>
        <body data-library="dartkart.layer" data-type="Tile">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">Dart Documentation</a>
         &rsaquo; <a href="../dartkart.layer.html">dartkart.layer</a> &rsaquo; <a href="../dartkart.layer/Tile.html">Tile</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
<h2><div class="icon-library"></div><a href="../dartkart.html">dartkart</a></h2><h2><div class="icon-library"></div><a href="../dartkart.core.html">dartkart.core</a></h2><h2><div class="icon-library"></div><a href="../dartkart.geo.html">dartkart.geo</a></h2><h2><div class="icon-library"></div><a href="../dartkart.geometry.html">dartkart.geometry</a></h2><h2><div class="icon-library"></div><a href="../dartkart.layer.html">dartkart.layer</a></h2><ul class="icon">
<li><a href="../dartkart.layer/CanvasRenderer.html"><div class="icon-class"></div>CanvasRenderer</a></li>
<li><a href="../dartkart.layer/ImgGridRenderer.html"><div class="icon-class"></div>ImgGridRenderer</a></li>
<li><a href="../dartkart.layer/Layer.html"><div class="icon-class"></div>Layer</a></li>
<li><a href="../dartkart.layer/OsmTileLayer.html"><div class="icon-class"></div>OsmTileLayer</a></li>
<li><a href="../dartkart.layer/Renderer.html"><div class="icon-class"></div>Renderer</a></li>
<li><div class="icon-class"></div><strong>Tile</strong></li>
<li><a href="../dartkart.layer/TileCache.html"><div class="icon-class"></div>TileCache</a></li>
<li><a href="../dartkart.layer/TileLayer.html"><div class="icon-class"></div>TileLayer</a></li>
<li><a href="../dartkart.layer/WMSLayer.html"><div class="icon-class"></div>WMSLayer</a></li>
</ul>
<h2><div class="icon-library"></div><a href="../dartkart.map.html">dartkart.map</a></h2></div>
<div class="content">
        <h2><strong>Tile</strong>
          class
        </h2>
        
<button id="show-inherited" class="show-inherited">Hide inherited</button>
<div class="doc">
<p>Tile represents a map tile. </p>
<pre class="source">
class Tile {
 /// indicates that the tile is loading the tile image
 static const LOADING = 0;
 /// indicates that the tile image is ready for rendering
 static const READY = 1;
 /// indicates that an error occured when loading the tile image
 static const ERROR= 2;

 /// the tile coordinats
 final Point2D tc;
 /// the layer this tile is rendered on 
 final TileLayer layer;
 
 CanvasElement _canvas;
 ImageElement _img;
 int _state = LOADING;

 /**
  * Creates a tile at tile coordinates [tc] = (ti, tj)
  * for the layer [layer]. It will be rendered on
  * [_canvas].
  */
 Tile(this.tc, this._canvas, this.layer);

 /**
  * Detach the tile from the map viewport.
  *
  * A detached tile whose image becomes available isn't
  * rendered anymore.
  */
 void detach() =&gt; _canvas = null;

 /**
  * Trigger loading of the tile image.
  */
 void load() {
    var url = layer.bindTileToUrl(tc.x, tc.y, layer.map.zoom);
    _img = _DEFAULT_CACHE.lookup(url,
     onLoad: (e) {
       _state = READY;
       render();
     },
     onError: (e) {
       _state = ERROR;
       render();
     }
   );
    _state = _img.complete ? READY : LOADING;
   render();
 }

 /// the top left corner in viewport coordinates where the tile
 /// should be rendered
 Point2D get _topLeftInViewport =&gt;
     layer.map.zoomPlaneToViewport(tc.scale(
         sx: layer.tileSize.width,
         sy: layer.tileSize.height
     ));

 void _renderReady() {
   if (_canvas == null) return;
   var context = _canvas.context2D;
   context.globalAlpha = layer.opacity;
   var tl = _topLeftInViewport;
   var ts = layer.tileSize;
   context.clearRect(tl.x, tl.y, ts.width, ts.height);
   context.drawImage(_img, tl.x, tl.y);
 }

 /// Returns the image of the parent tile of this tile, provided 
 /// there is a parent tile and its image is already in the cache.
 /// Otherwise returns [:null:].
 ImageElement get _parentImage {
   var z = layer.map.zoom;
   if (z == 0) return null;
   z--;
   var ti = tc.x ~/ 2;
   var tj = tc.y ~/ 2;
   var url = layer.bindTileToUrl(ti, tj, z);
   var img = _DEFAULT_CACHE.get(url);
   return img;
 }

 void _renderLoading() {
   var img = _parentImage;
   var context = _canvas.context2D;
   if (img == null) {      
     var tl = _topLeftInViewport;
     var ts = layer.tileSize;
     context.clearRect(tl.x,tl.y, ts.width, ts.height);
   } else {
     var tl = _topLeftInViewport;
     var ts = layer.tileSize;
     // the quadrant of the parent tile to be rendered (scaled by 2)
     // in place of the current tile
     var src = new html.Rect(
         (tc.x % 2) * ts.width ~/ 2,
         (tc.y % 2) * ts.height ~/ 2,
         ts.width ~/ 2,
         ts.height ~/ 2
     );
     // the rectangle where the current tile is rendered
     var dest = new html.Rect(tl.x, tl.y, ts.width, ts.height);
     context.drawImageToRect(img,dest,sourceRect:src);
   }
 }

 void _renderError() {
   var context = _canvas.context2D;
   context.globalAlpha = layer.opacity;
   var ts = layer.tileSize;
   var tl = _topLeftInViewport;
   var center = 
        new Point2D(tl.x, tl.y) 
     + (new Point2D(ts.width, ts.height) / 2).toInt();
   
   context
     ..save()
     ..strokeStyle="rgba(255,0,0,0.5)"
     ..lineWidth=10
     ..beginPath()
     ..arc(center.x, center.y, 50, 0, math.PI * 2, true)
     ..stroke()
     ..beginPath()
     ..moveTo(center.x - 30, center.y -30)
     ..lineTo(center.x + 30, center.y + 30)
     ..moveTo(center.x - 30, center.y + 30)
     ..lineTo(center.x +30 , center.y - 30)
     ..stroke()
     ..restore()
     ;
 }

 /// renders the tile
 void render() {
   if (_canvas == null) return;
   switch(_state) {
     case LOADING: _renderLoading(); break;
     case READY: _renderReady(); break;
     case ERROR: _renderError(); break;
   }
 }
}
</pre>
</div>
<div>
<h3>Static Properties</h3>
<div class="field"><h4 id="ERROR">
<button class="show-code">Code</button>
const         <strong>ERROR</strong> <a class="anchor-link"
            href="#ERROR"
            title="Permalink to Tile.ERROR">#</a>
        </h4>
        <div class="doc">
<p>indicates that an error occured when loading the tile image</p>
<pre class="source">
static const ERROR= 2
</pre>
</div>
</div>
<div class="field"><h4 id="LOADING">
<button class="show-code">Code</button>
const         <strong>LOADING</strong> <a class="anchor-link"
            href="#LOADING"
            title="Permalink to Tile.LOADING">#</a>
        </h4>
        <div class="doc">
<p>indicates that the tile is loading the tile image</p>
<pre class="source">
static const LOADING = 0
</pre>
</div>
</div>
<div class="field"><h4 id="READY">
<button class="show-code">Code</button>
const         <strong>READY</strong> <a class="anchor-link"
            href="#READY"
            title="Permalink to Tile.READY">#</a>
        </h4>
        <div class="doc">
<p>indicates that the tile image is ready for rendering</p>
<pre class="source">
static const READY = 1
</pre>
</div>
</div>
</div>
<div>
<h3>Constructors</h3>
<div class="method"><h4 id="Tile">
<button class="show-code">Code</button>
new <strong>Tile</strong>(<a href="../dartkart.geometry/Point2D.html">Point2D</a> tc, <a href="http://api.dartlang.org/dart_html/CanvasElement.html">CanvasElement</a> _canvas, <a href="../dartkart.layer/TileLayer.html">TileLayer</a> layer) <a class="anchor-link" href="#Tile"
              title="Permalink to Tile.Tile">#</a></h4>
<div class="doc">
<p>Creates a tile at tile coordinates 
<span class="param">tc</span> = (ti, tj)
for the layer 
<span class="param">layer</span>. It will be rendered on

<span class="param">_canvas</span>.</p>
<pre class="source">
Tile(this.tc, this._canvas, this.layer);
</pre>
</div>
</div>
</div>
<div>
<h3>Properties</h3>
<div class="field"><h4 id="layer">
<button class="show-code">Code</button>
final <a href="../dartkart.layer/TileLayer.html">TileLayer</a>         <strong>layer</strong> <a class="anchor-link"
            href="#layer"
            title="Permalink to Tile.layer">#</a>
        </h4>
        <div class="doc">
<p>the layer this tile is rendered on </p>
<pre class="source">
final TileLayer layer
</pre>
</div>
</div>
<div class="field"><h4 id="tc">
<button class="show-code">Code</button>
final <a href="../dartkart.geometry/Point2D.html">Point2D</a>         <strong>tc</strong> <a class="anchor-link"
            href="#tc"
            title="Permalink to Tile.tc">#</a>
        </h4>
        <div class="doc">
<p>the tile coordinats</p>
<pre class="source">
final Point2D tc
</pre>
</div>
</div>
</div>
<div>
<h3>Methods</h3>
<div class="method"><h4 id="detach">
<button class="show-code">Code</button>
void <strong>detach</strong>() <a class="anchor-link" href="#detach"
              title="Permalink to Tile.detach">#</a></h4>
<div class="doc">
<p>Detach the tile from the map viewport.</p>
<p>A detached tile whose image becomes available isn't
rendered anymore.</p>
<pre class="source">
void detach() =&gt; _canvas = null;
</pre>
</div>
</div>
<div class="method"><h4 id="load">
<button class="show-code">Code</button>
void <strong>load</strong>() <a class="anchor-link" href="#load"
              title="Permalink to Tile.load">#</a></h4>
<div class="doc">
<p>Trigger loading of the tile image.</p>
<pre class="source">
void load() {
  var url = layer.bindTileToUrl(tc.x, tc.y, layer.map.zoom);
  _img = _DEFAULT_CACHE.lookup(url,
   onLoad: (e) {
     _state = READY;
     render();
   },
   onError: (e) {
     _state = ERROR;
     render();
   }
 );
  _state = _img.complete ? READY : LOADING;
 render();
}
</pre>
</div>
</div>
<div class="method"><h4 id="render">
<button class="show-code">Code</button>
void <strong>render</strong>() <a class="anchor-link" href="#render"
              title="Permalink to Tile.render">#</a></h4>
<div class="doc">
<p>renders the tile</p>
<pre class="source">
void render() {
 if (_canvas == null) return;
 switch(_state) {
   case LOADING: _renderLoading(); break;
   case READY: _renderReady(); break;
   case ERROR: _renderError(); break;
 }
}
</pre>
</div>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        <div class="footer">
          <div>This page was generated at 2013-06-02 17:31:28.080</div>
        </div>
        <script async src="../client-static.js"></script>
        </body></html>
        
